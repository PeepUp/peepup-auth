generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Identity {
  id            String    @id @default(uuid())
  avatar        String    @default("")
  email         String    @unique
  emailVerified DateTime?
  firstName     String    @default("")
  lastName      String    @default("")
  password      String
  phoneNumber   String?   @unique
  state         String    @default("active")
  username      String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relation fields
  tokens Token[]
  roles  Role[]

  providerId Int?
  provider   Provider? @relation(fields: [providerId], references: [id])

  @@unique([email, username, phoneNumber])
  @@map(name: "identities")
}

model Role {
  id          Int          @id @default(autoincrement())
  type        UserRoleType @default(volunteer)
  permissions Permission[]

  // relation fields
  identityId String?   @unique
  identity   Identity? @relation(fields: [identityId], references: [id])
}

model Permission {
  id       Int     @id @default(autoincrement())
  action   String?
  resource String?

  // relation fields
  attributes Attribute[]

  roleId Int?
  role   Role? @relation(fields: [roleId], references: [id])

  @@map(name: "permissions")
}

model Attribute {
  id        Int      @id @default(autoincrement())
  name      String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relation fields
  permissionId Int?
  permission   Permission? @relation(fields: [permissionId], references: [id])

  @@map("attributes")
}

model Provider {
  id                  Int       @id @default(autoincrement())
  name                String
  userProviderId      String
  type                String
  slug                String
  tokenUrl            String
  authUrl             String
  clientId            String
  clientSecret        String
  scope               String
  callbackUrl         String
  state               String
  nonce               String
  params              String
  version             String
  accessToken         String
  accessTokenExpires  DateTime?
  refreshToken        String
  refreshTokenExpires DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // relation fields
  identities Identity[]

  @@map(name: "provider")
}

model Token {
  id                        Int       @id @default(autoincrement())
  expires_at                DateTime?
  access_token              String
  refresh_token             String
  blacklisted_access_token  String
  blacklisted_refresh_token String

  // relation fields
  identityId String?
  identity   Identity? @relation(fields: [identityId], references: [id])

  @@index([identityId], name: "identityId")
  @@map(name: "tokens")
}

enum UserRoleType {
  admin
  volunteer
  organization
}
